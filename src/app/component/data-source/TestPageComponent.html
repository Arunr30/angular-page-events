<div *ngIf="loading()">
  <p>Loading data...</p>
</div>

<div *ngIf="!loading()">
  <!-- Active Data Sources -->
  <div *ngIf="usageList().length === 0">
    <p>No data sources found.</p>
  </div>

  <div *ngFor="let group of usageList(); let i = index" style="margin-bottom: 2rem">
    <!-- OWNER HEADER -->
    <div
      style="
        padding: 0.75rem;
        background: #f1f1f1;
        border-radius: 6px;
        margin-bottom: 0.75rem;
        font-weight: 600;
      "
    >
      Owner ID: {{ group.ownerId }} ({{ group.items.length }} Data Sources)
    </div>

    <!-- DS Cards -->
    <div
      *ngFor="let usage of group.items; let idx = index"
      class="ds-card"
      style="
        margin-bottom: 1rem;
        padding: 0.75rem;
        border: 1px solid #ccc;
        border-radius: 6px;
        background-color: #fafafa;
      "
    >
      <!-- DS NAME -->
      <div>
        <strong>{{ idx + 1 }}. dsName:</strong> {{ usage.dsName }}
      </div>

      <!-- CONTROL INFO -->
      <div style="margin-top: 0.5rem">
        <div *ngIf="usage.controls.length > 0; else noControlMatch">
          <div *ngFor="let ctrl of usage.controls" style="margin-bottom: 6px">
            <div *ngIf="ctrl.controlName">
              <strong>Control Name:</strong> {{ ctrl.controlName }}
            </div>

            <div *ngIf="ctrl.parentInstanceId">
              <strong>Parent Instance ID:</strong> {{ ctrl.parentInstanceId }}
            </div>

            <hr />
          </div>
        </div>

        <ng-template #noControlMatch>
          <div style="color: #d9534f">Owner ID not matched with any control instance</div>
        </ng-template>
      </div>

      <!-- MAPPED FIELDS -->
      <div style="margin-top: 0.5rem">
        <strong>Mapped Fields:</strong>
        <span *ngIf="usage.mappedFields.length > 0" style="color: green">
          [{{ usage.mappedFields.join(', ') }}]
        </span>
        <span *ngIf="usage.mappedFields.length === 0" style="color: #999"> No fields found </span>
      </div>

      <!-- STATUS BADGE -->
      <div style="margin-top: 0.5rem">
        <span
          *ngIf="usage.hasMapping"
          style="
            background: #d4edda;
            color: #155724;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
          "
        >
          ✔ In Use
        </span>

        <span
          *ngIf="!usage.hasMapping"
          style="
            background: #f8d7da;
            color: #721c24;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
          "
        >
          ✖ Not Used
        </span>
      </div>
    </div>
  </div>

  <!-- Completely Unused Data Sources -->
  <h3>Completely Unused Data Sources</h3>

  <div *ngIf="unusedList().length === 0">
    <p>All data sources are in use.</p>
  </div>

  <div *ngFor="let item of unusedList(); let i = index">
    {{ i + 1 }}. Owner: {{ item.ownerId }} — DS: {{ item.dsName }}
  </div>
</div>
