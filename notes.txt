import { Component, OnInit, signal } from '@angular/core';
import { CommonModule } from '@angular/common';
import { catchError, forkJoin, of } from 'rxjs';

import { ApiService } from '../../service/api-service';
import { PageEventsService } from '../../service/page-events';
import { ControlInstanceService } from '../../service/control-instance';

interface DsUsage {
  dsName: string;
  mappedFields: string[];
}

@Component({
  selector: 'app-test-page',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './TestPageComponent.html',
  styleUrls: ['./TestPageComponent.css'],
})
export class TestPageComponent implements OnInit {
  usageList = signal<DsUsage[]>([]);
  loading = signal(true);

  constructor(
    private dsService: ApiService,
    private pageEventsService: PageEventsService,
    private controlInstanceService: ControlInstanceService,
  ) {}

  ngOnInit(): void {
    this.loadAll();
  }

  private loadAll() {
    forkJoin({
      dataSources: this.dsService.getData().pipe(
        catchError((err) => {
          console.error('DS error', err);
          return of([]);
        }),
      ),
      pageEvents: this.pageEventsService.getPageEvents().pipe(
        catchError((err) => {
          console.error('Page Events error', err);
          return of([]);
        }),
      ),
      controlInstances: this.controlInstanceService.getControlInstances().pipe(
        catchError((err) => {
          console.error('Control Instances error', err);
          return of([]);
        }),
      ),
    }).subscribe({
      next: ({ dataSources, pageEvents, controlInstances }: any) => {
        console.log('DataSources:', dataSources);
        console.log('PageEvents:', pageEvents);
        console.log('ControlInstances:', controlInstances);

        this.buildUsage(dataSources, pageEvents, controlInstances);
        this.loading.set(false);
      },
      error: (err) => {
        console.error('Error loading data:', err);
        this.loading.set(false);
      },
    });
  }

  private buildUsage(dataSources: any, pageEvents: any, controlInstances: any) {
    const result: DsUsage[] = [];

    // Filter out DS items with type MView (top-level)
    const allDSItems = [
      ...(dataSources?.published || []).filter((ds: any) => ds.type !== 'MView'),
      ...(dataSources?.drafts || []).filter((ds: any) => ds.type !== 'MView')
    ];

    // Get unique dsNames
    const dsNamesSet = new Set<string>();
    allDSItems.forEach((item) => {
      if (item.dsName) dsNamesSet.add(item.dsName);
    });

    // Stringify everything for regex search
    const dataSourcesStr = JSON.stringify(dataSources || {});
    const pageEventsStr = JSON.stringify(pageEvents || {});
    const controlInstancesStr = JSON.stringify(controlInstances || {});

    dsNamesSet.forEach((dsName) => {
      const fieldsSet = new Set<string>();

      //  Parse each DS item method/draftJson explicitly
      allDSItems.forEach((item) => {
        if (item.dsName !== dsName) return;

        // Method JSON
        if (item.method) {
          try {
            const methodObj = JSON.parse(item.method);
            methodObj.params?.forEach((p: any) => {
              if (p.dsFieldName) fieldsSet.add(p.dsFieldName);
            });
            methodObj.returningResult?.forEach((r: any) => {
              if (r.name) fieldsSet.add(r.name);
            });
          } catch (e) {
            console.warn('Invalid method JSON', e);
          }
        }

        // Draft JSON
        if (item.draftJsonModel) {
          try {
            const draftObj = JSON.parse(item.draftJsonModel);
            draftObj.params?.forEach((p: any) => {
              if (p.dsFieldName) fieldsSet.add(p.dsFieldName);
            });
            draftObj.returningResult?.forEach((r: any) => {
              if (r.name) fieldsSet.add(r.name);
            });
          } catch (e) {
            console.warn('Invalid draftJsonModel JSON', e);
          }
        }
      });

      //  Apply regex to entire stringified datasource, pageEvents, controlInstances
      const regex = new RegExp(`${dsName}\\.([a-zA-Z0-9_\\-]+)`, 'g');
      let match;

      while ((match = regex.exec(dataSourcesStr)) !== null) {
        fieldsSet.add(match[1]);
      }

      while ((match = regex.exec(pageEventsStr)) !== null) {
        fieldsSet.add(match[1]);
      }

      while ((match = regex.exec(controlInstancesStr)) !== null) {
        fieldsSet.add(match[1]);
      }

      result.push({
        dsName,
        mappedFields: Array.from(fieldsSet),
      });
    });

    this.usageList.set(result);
  }
}